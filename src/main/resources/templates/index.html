<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/index.css}">
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="navbar">
        <div class="navbar-inner">
            <a href="#">ê²Œì‹œë¬¼</a>
            <a href="#">ê²€ìƒ‰</a>
            <a href="#">í”„ë¡œí•„</a>
        </div>
    </div>

    <div class="post-create">
        <form th:action="@{/board}" method="post" th:object="${board}" enctype="multipart/form-data">
            <div style="display: flex; align-items: center;">
                <img class="profile-img" src="/images/basci.png" alt="í”„ë¡œí•„">
            </div>
            <div>
                <input type="text" th:field="*{boardContent}" placeholder="ë¬´ì—‡ì„ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?">
            </div>

            <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìŠ¬ë¼ì´ë“œ -->
            <div class="image-slider">
                <button type="button" class="slide-btn left" onclick="slide(-1)">&#10094;</button>
                <div class="preview-container" id="preview-container"></div>
                <button type="button" class="slide-btn right" onclick="slide(1)">&#10095;</button>
            </div>

            <div class="buttons">
                <input type="file" class="upload-btn" name="files"  onchange="preView(this);" multiple accept="image/*" />
                <button class="file-btn" onclick="ImgUpload(event)">ì´ë¯¸ì§€ ì„ íƒ</button>
                <button class="submit-btn">ì‘ì„± ì™„ë£Œ</button>
            </div>
        </form>
    </div>

    <div class="post">
        <div class="post-header">
            <img class="profile-img" src="/images/profile.png" alt="í”„ë¡œí•„">
            <div class="user-info">
                <span>í™ê¸¸ë™</span>
                <span>@hong123</span>
            </div>
            <span class="time">5ë¶„ ì „</span>
        </div>
        <div class="post-content">
            ì˜¤ëŠ˜ ì •ë§ ì¦ê±°ìš´ í•˜ë£¨ì˜€ì–´ìš”!
        </div>
        <img src="/images/sample.jpg" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€">
        <div class="post-actions">
            <span class="toggle-comments">ğŸ’¬ 10</span>
            <span>â¤ï¸ 25</span>
            <span>ğŸ‘€ 100</span>
        </div>
        <div class="comment-section">
            <div class="comment-input">
                <img class="profile-img" src="/images/profile.png" alt="í”„ë¡œí•„">
            </div>

            <div class="comment-font">
                <input type="text" placeholder="ë¬´ì—‡ì„ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?">
            </div>

            <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìŠ¬ë¼ì´ë“œ -->
            <div class="image-slider">
                <button type="button" class="slide-btn left" onclick="slide(-1)">&#10094;</button>
                <div class="preview-container" id="coment-container"></div>
                <button type="button" class="slide-btn right" onclick="slide(1)">&#10095;</button>
            </div>

            <div class="comment-btn">
                <input type="file" class="upload-btn commentupload-btn" name="commentfiles"  onchange="preView(this);" multiple accept="image/*" />
                <button class="file-btn" onclick="CommentImgUpload(event)">ì´ë¯¸ì§€ ì„ íƒ</button>
                <button class="comment-submit">ì‘ì„±</button>
            </div>
        </div>
    </div>


</th:block>
</body>
</html>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const commentToggles = document.querySelectorAll(".toggle-comments");

        commentToggles.forEach(toggle => {
            toggle.addEventListener("click", function () {
                const commentSection = this.closest(".post").querySelector(".comment-section");
                if (commentSection.style.display === "none" || commentSection.style.display === "") {
                    commentSection.style.display = "block";
                } else {
                    commentSection.style.display = "none";
                }
            });
        });
    });

    function ImgUpload(event){
        event.preventDefault(); // ê¸°ë³¸ ì´ë²¤íŠ¸(í¼ ì œì¶œ) ë°©ì§€
        document.querySelector(".upload-btn").click();
    }

    function CommentImgUpload(event) {
        event.preventDefault();
        document.querySelector(".commentupload-btn").click();
    }


    // íŒŒì¼ ì´ë¯¸ì§€ preView
    let postImages = [];  // ê²Œì‹œë¬¼ ì´ë¯¸ì§€ ë°°ì—´
    let commentImages = []; // ëŒ“ê¸€ ì´ë¯¸ì§€ ë°°ì—´

    function preView(input) {
        const isComment = input.classList.contains("commentupload-btn");
        const previewContainer = isComment
            ? document.getElementById("coment-container")
            : document.getElementById("preview-container");

        let images = isComment ? commentImages : postImages;

        if (input.files.length + images.length > 10) {
            alert("ìµœëŒ€ 10ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        Array.from(input.files).forEach((file) => {
            if (!file.type.startsWith("image/")) return;

            images.push(file);

            const reader = new FileReader();
            reader.onload = function (e) {
                const imgWrapper = document.createElement("div");
                imgWrapper.classList.add("preview-wrapper");

                const img = document.createElement("img");
                img.src = e.target.result;
                img.classList.add("preview-img");

                const closeBtn = document.createElement("span");
                closeBtn.classList.add("preview-close");
                closeBtn.textContent = "X";
                closeBtn.onclick = function () {
                    removeImage(file, isComment);
                };

                imgWrapper.appendChild(img);
                imgWrapper.appendChild(closeBtn);
                previewContainer.appendChild(imgWrapper);
            };
            reader.readAsDataURL(file);
        });

        updateFileInput(isComment);
    }

    function removeImage(index, isComment) {
        let images = isComment ? commentImages : postImages;
        const previewContainer = isComment
            ? document.getElementById("coment-container")
            : document.getElementById("preview-container");

        // ë°°ì—´ì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ íŒŒì¼ ì œê±°
        images.splice(index, 1);

        // ìƒˆë¡œìš´ DataTransfer ê°ì²´ ìƒì„± (íŒŒì¼ ì¸í’‹ ê°’ ì—…ë°ì´íŠ¸)
        const dataTransfer = new DataTransfer();
        images.forEach(file => dataTransfer.items.add(file));

        // íŒŒì¼ ì¸í’‹ ê°’ ì—…ë°ì´íŠ¸
        const fileInput = document.querySelector(isComment ? ".commentupload-btn" : ".upload-btn");
        fileInput.files = dataTransfer.files;

        // ë¯¸ë¦¬ë³´ê¸° ë‹¤ì‹œ ë Œë”ë§ (ìˆœì„œ ìœ ì§€)
        previewContainer.innerHTML = '';
        images.forEach((file, newIndex) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const imgWrapper = document.createElement("div");
                imgWrapper.classList.add("preview-wrapper");

                const img = document.createElement("img");
                img.src = e.target.result;
                img.classList.add("preview-img");

                const closeBtn = document.createElement("span");
                closeBtn.classList.add("preview-close");
                closeBtn.textContent = "X";
                closeBtn.onclick = function () {
                    removeImage(newIndex, isComment);
                };

                imgWrapper.appendChild(img);
                imgWrapper.appendChild(closeBtn);
                previewContainer.appendChild(imgWrapper);
            };
            reader.readAsDataURL(file);
        });
    }


    function updateFileInput(isComment) {
        const dataTransfer = new DataTransfer();
        let images = isComment ? commentImages : postImages;

        images.forEach(file => dataTransfer.items.add(file));
        document.querySelector(isComment ? ".commentupload-btn" : ".upload-btn").files = dataTransfer.files;
    }

</script>