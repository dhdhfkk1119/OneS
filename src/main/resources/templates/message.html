<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/index.css}">
        <link rel="stylesheet" th:href="@{/css/message.css}">
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="message-container">
        <!-- 1. Profile Info -->
        <div class="profile-info">
            <a href="/">
                <div class="nav-item">
                    <img th:src="@{'/local-images/home-icon.png'}" alt="">
                    <span>홈</span>
                </div>
            </a>
            <a href="/search">
                <div class="nav-item">
                    <img th:src="@{'/local-images/search-message.png'}" alt="">
                    <span>탐색하기</span>
                </div>
            </a>
            <a href="">
                <div class="nav-item">
                    <img th:src="@{'/local-images/alarm-clock.png'}" alt="">
                    <span>알림</span>
                </div>
            </a>
            <a th:href="@{${'/message/' + memberIdx}}">
                <div class="nav-item">
                    <img th:src="@{'/local-images/email.png'}" alt="">
                    <span>쪽지</span>
                </div>
            </a>
            <a th:href="@{${'/profile/' + memberIdx}}">
                <div class="nav-item">
                    <img th:src="@{'/local-images/profile-user.png'}" alt="">
                    <span>프로필</span>
                </div>
            </a>
            <a href="/boardWrite">
                <div class="nav-item">
                    <img th:src="@{'/local-images/write.png'}" alt="">
                    <span>작성하기</span>
                </div>
            </a>

            <div class="bottom-profile">
                <img th:src="@{${'/profile-images/' + login.userImage}}" alt="프로필">
                <div>
                    <div class="bottom-name" th:text="${login.userName}"></div>
                    <div class="bottom-id" th:text="${login.userId}"></div>
                </div>
            </div>
        </div>

        <!-- 2. Message List -->
        <div class="message-list">
            <div class="message-header">
                <span>쪽지</span>
                <button style="float:right;">메세지 추가하기</button>
            </div>
            <input type="text" placeholder="쪽지 검색하기" class="message-list-input">
            <div class="message-items">
                <!-- 반복 렌더링 되는 쪽지 리스트 -->
                <div class="message-item">김철수</div>
                <div class="message-item">이영희</div>
                <!-- ... -->
            </div>
        </div>

        <!-- 3. Message Detail -->
        <div class="message">
            <div class="user-details">
                <img th:src="@{${'/profile-images/' + member.userImage}}" alt="유저 이미지" class="user-details-img">
                <div th:text="${member.userName}"></div>
                <div th:text="${member.userId}"></div>
                <div th:text="${member.introduce}"></div>
                <div class="user-calendar">
                    <img src="/local-images/calendar.png" alt="" class="user-details-calendar">
                    <span th:text="${member.userAt}">가입일: 2022-05-20</span>
                </div>
                <div th:text="${member.follow}">팔로워: 512명</div>
                <div>팔로잉 상태: 서로 팔로우 중</div>
            </div>
            <div class="message-web-list" id="messageContainer">
                <div th:each="msg : ${messages}">
                    <div th:class="${msg.senderIdx == login.idx} ? 'message-row right-span' : 'message-row left-span'">
                        <span th:class="${msg.senderIdx == login.idx} ? 'send-message' : 'receive-message'">
                            <p th:text="${msg.content}"></p>
                        </span>
                    </div>
                </div>
            </div> <!-- 여백 -->


            <div class="message-compose">
                <div class="compose-input">
                    <label for="imageUpload" style="cursor: pointer;display: flex">
                        <img th:src="@{'/local-images/image-file.png'}" alt="" width="20px">
                    </label>
                    <input type="hidden" id="loginIdx" th:value="${login.idx}">
                    <input type="hidden" id="targetIdx" th:value="${member.idx}">
                    <input type="file" id="imageUpload" style="display: none;">
                    <input type="text" id="msgInput" placeholder="새 쪽지 작성하기">
                    <button onclick="sendMessage()">보내기</button>
                </div>
            </div>
        </div>
    </div>
</th:block>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;

    function connectSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            console.log('Connected to WebSocket');

            // 메시지 수신 구독
            stompClient.subscribe('/topic/messages', function (message) {
                const msg = JSON.parse(message.body);
                console.log('메세지 도착:', msg);
                showMessage(msg);
            });
        });
    }

    function sendMessage() {
        const senderIdx = document.getElementById("loginIdx").value;
        const receiverIdx = document.getElementById("targetIdx").value;
        const message = document.getElementById("msgInput").value;


        stompClient.send("/app/chat/send", {}, JSON.stringify({
            senderIdx: senderIdx,
            receiverIdx: receiverIdx,
            content: message,
            imagesContent: ''
        }));
    }

    const myIdx = [[${login.idx}]];

    function showMessage(message) {
        const messageContainer = document.getElementById('messageContainer');

        const messageRow = document.createElement('div');
        messageRow.classList.add('message-row');

        const bubble = document.createElement('span');
        const p = document.createElement('p');
        p.textContent = message.content;
        bubble.appendChild(p);

        // 보낸 사람과 받은 사람 구분
        if (parseInt(message.senderIdx) === myIdx) {
            messageRow.classList.add('right-span');
            bubble.classList.add('send-message');
        } else {
            messageRow.classList.add('left-span');
            bubble.classList.add('receive-message');
        }

        messageRow.appendChild(bubble);
        messageContainer.appendChild(messageRow);
    }

    connectSocket();
</script>