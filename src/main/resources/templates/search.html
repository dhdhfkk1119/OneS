<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/index.css}">
        <link rel="stylesheet" th:href="@{/css/search.css}">
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="main-container">
        <div class="search-container">
            <div class="search-info">
                <a href="/">
                    <div class="nav-item">
                        <img th:src="@{'/local-images/home-icon.png'}" alt="">
                        <span>Ìôà</span>
                    </div>
                </a>
                <a href="/search">
                    <div class="nav-item">
                        <img th:src="@{'/local-images/search-message.png'}" alt="">
                        <span>ÌÉêÏÉâÌïòÍ∏∞</span>
                    </div>
                </a>
                <a href="">
                    <div class="nav-item">
                        <img th:src="@{'/local-images/alarm-clock.png'}" alt="">
                        <span>ÏïåÎ¶º</span>
                    </div>
                </a>
                <!-- Î°úÍ∑∏Ïù∏Ìïú Í≤ΩÏö∞ -->
                <div th:if="${member != null}">
                    <a th:href="@{'/message/' + ${member.idx}}">
                        <div class="nav-item">
                            <img th:src="@{'/local-images/email.png'}" alt="">
                            <span>Ï™ΩÏßÄ</span>
                        </div>
                    </a>
                    <a th:href="@{'/profile/' + ${member.idx}}">
                        <div class="nav-item">
                            <img th:src="@{'/local-images/profile-user.png'}" alt="">
                            <span>ÌîÑÎ°úÌïÑ</span>
                        </div>
                    </a>
                </div>

                <!-- Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ -->
                <div th:if="${member == null}">
                    <div class="nav-item" onclick="alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§');">
                        <img th:src="@{'/local-images/email.png'}" alt="">
                        <span>Ï™ΩÏßÄ</span>
                    </div>
                    <div class="nav-item" onclick="alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§');">
                        <img th:src="@{'/local-images/profile-user.png'}" alt="">
                        <span>ÌîÑÎ°úÌïÑ</span>
                    </div>
                </div>
                <a href="/boardWrite">
                    <div class="nav-item">
                        <img th:src="@{'/local-images/write.png'}" alt="">
                        <span>ÏûëÏÑ±ÌïòÍ∏∞</span>
                    </div>
                </a>

                <div class="bottom-profile">
                    <div class="bottom-profile-inner" sec:authorize="isAuthenticated()">
                        <a th:href="@{${'/profile/' + member.idx}}">
                            <img th:src="@{${'/profile-images/' + member.userImage}}" alt="ÌîÑÎ°úÌïÑ">
                        </a>
                        <div>
                            <div class="bottom-name" th:text="${member.userName}"></div>
                            <div class="bottom-id" th:text="${'@' +member.userId}"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="search-input">
                <div class="search-input-wrapper" style="position: relative;">
                    <div class="search-input-inner">
                        <div class="search-input-middle">
                            <input type="text" placeholder="Í≤ÄÏÉâ" name="search" id="search"
                                   th:value="${keyword}" autocomplete="off">
                            <img src="/local-images/send.png" alt="" width="20px" class="search-send-btn"
                                 onclick="searchBtn()">
                        </div>
                        <div class="search-sort" th:if="${keyword != null and keyword != ''}">
                            <ul>
                                <li>
                                    <button class="sort-btn" th:value="'viewst'"
                                            th:classappend="${sort} == 'viewst' ? 'active' : ''">Ïù∏Í∏∞ Í≤åÏãúÎ¨º
                                    </button>
                                </li>
                                <li>
                                    <button class="sort-btn" th:value="'latest'"
                                            th:classappend="${sort} == 'latest' ? 'active' : ''">ÏµúÏã† Í≤åÏãúÎ¨º
                                    </button>
                                </li>
                                <li>
                                    <button class="sort-btn" th:value="'user'"
                                            th:classappend="${sort} == 'user' ? 'active' : ''">ÏÇ¨Ïö©Ïûê
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <!-- Í≤ÄÏÉâ Í∏∞Î°ùÏùÑ Î≥¥Ïó¨Ï§ÄÎã§-->
                        <div class="history-list" id="historyList" sec:authorize="isAuthenticated()">
                            <ul id="history-container" th:each=" history : ${searchHistoryList}">
                                <li>
                           <span class="history-btn" th:data-history="${history.searchKeyword}"
                                 th:text="${history.searchKeyword}"></span>
                                    <span class="history-delete" th:data-delete="${history.searchIdx}">x</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏûàÏùÑ ÎïåÎßå Î≥¥Ïó¨Ï§å -->
                <!--   Í≤åÏãúÍ∏Ä Î¶¨Ïä§Ìä∏  -->
                <div th:if="${boardList != null}">
                    <div class="post" th:each="boards : ${boardList}">
                        <div class="post-header">
                            <a th:href="@{'/profile/' + ${writers[boards.boardIdx].idx}}">
                                <img class="profile-img"
                                     th:src="@{'/profile-images/' + ${writers[boards.boardIdx].userImage}}" alt="ÌîÑÎ°úÌïÑ">
                            </a>
                            <div class="user-info">
                                <span class="user-name" th:text="${writers[boards.boardIdx].userName}"></span>
                                <span class="user-id" th:text="${'@' +writers[boards.boardIdx].userId}"></span>
                            </div>
                            <span class="time" th:data-time="${boards.boardAt}"></span>
                        </div>
                        <a class="boardDetail" th:href="@{${'/board/' + boards.boardIdx}}">
                            <div class="post-content" th:text="${boards.boardContent}">
                            </div>
                            <div class="board-img-list">
                                <div class="board-img-list-inner">
                                    <button class="board-slide-left">&#10094;</button>
                                    <div class="img-list-inner board-list"
                                         th:each="imgUrl : ${boardImages.get(boards.boardIdx)}">
                                        <img th:src="@{${'/board-images/' + imgUrl}}" alt="Í≤åÏãúÎ¨º Ïù¥ÎØ∏ÏßÄ">
                                    </div>
                                    <button class="board-slide-right">&#10095;</button>
                                </div>
                            </div>
                        </a>
                        <div class="post-actions">
                            <span class="toggle-comments">üí¨ <span th:text="${boards.boardComent}"></span></span>
                            <span>
                            <span class="boardLike-btn" th:data-board-idx="${boards.boardIdx}">‚ù§Ô∏è</span>
                            <span class="board-like-count" th:text="${boards.boardLike}"></span>
                        </span>
                            <span>üëÄ <span th:text="${boards.boardView}"></span></span>
                        </div>
                    </div>
                </div>

                <!-- Ïú†Ï†Ä Î¶¨Ïä§Ìä∏ -->
                <div class="user-list" th:if="${sort == 'user'}">
                    <div class="user-list-inner" th:each="m : ${memberList}">
                        <a th:href="@{${'/profile/' + m.idx}}">
                            <div class="user-item">
                                <div>
                                    <img th:src="@{${'/profile-images/' + m.getUserImage()}}" alt="" width="56">
                                </div>
                                <div>
                                    <div>
                                        <span class="user-name" th:text="${m.userName}"></span>
                                        <span class="user-id" th:text="${'@' +m.userId}"></span>
                                    </div>
                                    <div>
                                        <span class="user-content" th:text="${m.introduce}"></span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>
</body>
</html>
<script>
    // Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠
    function searchBtn() {
        const keyword = document.getElementById("search").value.trim();
        if (keyword === '') {
            alert("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }

        // ÏÑ†ÌÉùÎêú Ï†ïÎ†¨ Í∞í Í∞ÄÏ†∏Ïò§Í∏∞ (Í∏∞Î≥∏Í∞íÏùÄ viewst)
        const activeSort = document.querySelector('.sort-btn.active');
        const sortValue = activeSort ? activeSort.value : 'viewst';

        // Í≤ÄÏÉâÏñ¥ + Ï†ïÎ†¨ ÌååÎùºÎØ∏ÌÑ∞Î°ú Ïù¥Îèô
        const query = new URLSearchParams();
        query.append('keyword', keyword);
        query.append('sort', sortValue);

        location.href = '/search?' + query.toString();
        saveSearchKeywordToServer(keyword);

    }

    // ÏóîÌÑ∞ÌÇ§Î°ú Í≤ÄÏÉâ
    document.getElementById("search").addEventListener("keyup", function (event) {
        if (event.key === "Enter") {
            searchBtn();
        }
    });

    // Ï†ïÎ†¨ Î≤ÑÌäº ÌÅ¥Î¶≠
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('.sort-btn');

        buttons.forEach(button => {
            button.addEventListener('click', function () {
                const keyword = document.getElementById('search').value.trim();

                // Ï†ïÎ†¨ Î≤ÑÌäº active Ï≤òÎ¶¨
                buttons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // keywordÍ∞Ä ÏóÜÏúºÎ©¥ Í≤ÄÏÉâÏñ¥ ÏûÖÎ†• Ïú†ÎèÑ
                if (keyword === '') {
                    alert("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }

                const sortValue = this.value;

                const query = new URLSearchParams();
                query.append('keyword', keyword);
                query.append('sort', sortValue);

                location.href = '/search?' + query.toString();
            });
        });
    });

    // Í≤ÄÏÉâ Í∏∞Î°ù ÌÅ¥Î¶≠Ïãú Í≤ÄÏÉâÏñ¥Ïóê Îì±Î°ùÏù¥Îê®
    document.addEventListener("DOMContentLoaded", function () {
        const buttons = document.querySelectorAll('.history-btn');
        buttons.forEach(button => {
            button.addEventListener('click', function () {
                const historyValue = button.dataset.history;

                // ÏÑ†ÌÉùÎêú Ï†ïÎ†¨ Í∞í Í∞ÄÏ†∏Ïò§Í∏∞ (Í∏∞Î≥∏Í∞íÏùÄ viewst)
                const activeSort = document.querySelector('.sort-btn.active');
                const sortValue = activeSort ? activeSort.value : 'viewst';

                // Í≤ÄÏÉâÏñ¥ + Ï†ïÎ†¨ ÌååÎùºÎØ∏ÌÑ∞Î°ú Ïù¥Îèô
                const query = new URLSearchParams();
                query.append('keyword', historyValue);
                query.append('sort', sortValue);

                location.href = '/search?' + query.toString();

            });
        });
    });

    // ÏµúÍ∑º Í≤ÄÏÉâÍ∏∞Î°ù Í≤ÄÏÉâ Í∏∞Î°ù Î≥¥ÎÇ¥Í∏∞ Ï†ÄÏû•
    function saveSearchKeywordToServer(keyword) {
        const historyContainer = document.getElementById("history-container");
        const li = document.createElement("li");

        fetch('/search-history', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({keyword: keyword})
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("ÏÑúÎ≤Ñ ÏóêÎü¨ Î∞úÏÉù");
                }
                return response.json();
            })
            .then(data => {
                historyContainer.prepend(li); // ÏµúÍ∑º Í≤ÄÏÉâÏñ¥Í∞Ä ÏúÑÎ°ú Ïò§ÎèÑÎ°ù Ï∂îÍ∞Ä

                console.log("Í≤ÄÏÉâÏñ¥ Ï†ÄÏû• ÏÑ±Í≥µ:", data);
            })
            .catch(error => {
                console.error("Í≤ÄÏÉâÏñ¥ Ï†ÄÏû• Ïã§Ìå®:", error);
            });
    }

    //Í≤ÄÏÉâÏñ¥ ÏÇ≠Ï†úÍ∏∞Îä•
    document.addEventListener("DOMContentLoaded", function () {
        const buttons = document.querySelectorAll('.history-delete');

        buttons.forEach(button => {
            button.addEventListener('click', function () {
                const deleteValue = button.dataset.delete;
                const li = button.closest('li'); // Ìï¥Îãπ li ÏöîÏÜå

                fetch('/search-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({deleteValue: deleteValue})
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("ÏÑúÎ≤Ñ ÏóêÎü¨ Î∞úÏÉù");
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Í≤ÄÏÉâÏñ¥ ÏÇ≠Ï†ú ÏÑ±Í≥µ:", data);
                        // ÌôîÎ©¥ÏóêÏÑú Î∞îÎ°ú ÏÇ≠Ï†ú
                        if (li) {
                            li.remove();
                        }
                    })
                    .catch(error => {
                        console.error("Í≤ÄÏÉâÏñ¥ ÏÇ≠Ï†ú Ïã§Ìå®:", error);
                    });
            });
        });
    });


    // Ïù¥ÎØ∏ÏßÄ Ïä¨ÎùºÏù¥Îìú a ÎßÅÌÅ¨ ÎßâÍ∏∞
    // Ïù¥ÎØ∏ÏßÄ Ïä¨ÎùºÏù¥ Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú a ÌÉúÍ∑∏Î°ú Í∞ÄÎäî Ïù¥Îèô ÎßâÍ∏∞
    document.querySelectorAll('.board-slide-left, .board-slide-right')
        .forEach(btn => {
            btn.addEventListener('click', function (event) {
                event.preventDefault();      // a ÌÉúÍ∑∏ Ïù¥Îèô ÎßâÍ∏∞
                event.stopPropagation();    // Î∂ÄÎ™® ÏöîÏÜåÎ°ú Ïù¥Î≤§Ìä∏ Ï†ÑÌååÎèÑ ÎßâÍ∏∞

                // Ïä¨ÎùºÏù¥Îìú Î°úÏßÅ Ïã§Ìñâ
                console.log("Ïä¨ÎùºÏù¥Îìú Î≤ÑÌäº ÌÅ¥Î¶≠!");
            });
        });

    // ÌòÑÏû¨ ÏãúÍ∞ÑÏóêÏÑú - Í≤åÏã§Î¨º Ïò¨Î¶∞ ÏãúÍ∞Ñ ÎÇòÌÉÄÎÇ¥Í∏∞ ÏùºÏ£ºÏùºÍπåÏßÄÎßå
    document.addEventListener("DOMContentLoaded", function () {
        const timeElements = document.querySelectorAll(".time");

        timeElements.forEach(element => {
            const boardTime = new Date(element.getAttribute("data-time")); // Í≤åÏãúÎ¨º ÏãúÍ∞Ñ
            const now = new Date(); // ÌòÑÏû¨ ÏãúÍ∞Ñ

            const diff = Math.floor((now - boardTime) / 1000); // Ï¥à Îã®ÏúÑ Ï∞®Ïù¥

            let timeAgo;
            if (diff < 60) {
                timeAgo = "Î∞©Í∏à Ï†Ñ";
            } else if (diff < 3600) {
                timeAgo = Math.floor(diff / 60) + "Î∂Ñ Ï†Ñ";
            } else if (diff < 86400) {
                timeAgo = Math.floor(diff / 3600) + "ÏãúÍ∞Ñ Ï†Ñ";
            } else if (diff < 604800) {
                timeAgo = Math.floor(diff / 86400) + "Ïùº Ï†Ñ";
            } else {
                timeAgo = boardTime.toISOString().split("T")[0]; // 1Ï£º Ïù¥ÏÉÅÏù¥Î©¥ ÎÇ†Ïßú ÌëúÏãú
            }

            element.textContent = timeAgo;
        });
    });

    // Í≤åÏãúÎ¨º Ïù¥ÎØ∏ÏßÄ Ïä¨ÎùºÏù¥Îìú
    document.addEventListener("DOMContentLoaded", function () {
        const sliders = document.querySelectorAll(".board-img-list-inner");

        sliders.forEach(slider => {
            const imgContainer = slider.querySelectorAll(".board-list");
            const images = Array.from(imgContainer);
            const leftBtn = slider.querySelector(".board-slide-left");
            const rightBtn = slider.querySelector(".board-slide-right");
            let currentIndex = 0;
            const imgWidth = 285; // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ (275px + Ïó¨Î∞± 25px Í≥†Î†§)
            const maxIndex = images.length - 2; // ‚úÖ ÏµúÎåÄ Ïù¥Îèô Í∞ÄÎä• Ïù∏Îç±Ïä§

            // Ïä¨ÎùºÏù¥Îìú Ïù¥Îèô Ìï®Ïàò
            function updateSlide() {
                const offset = -(currentIndex * imgWidth);
                imgContainer.forEach(img => img.style.transform = `translateX(${offset}px)`);

                // ÏôºÏ™Ω Î≤ÑÌäº Ï†úÏñ¥
                leftBtn.style.display = currentIndex > 0 ? 'block' : 'none';

                // Ïò§Î•∏Ï™Ω Î≤ÑÌäº Ï†úÏñ¥
                rightBtn.style.display = currentIndex >= maxIndex ? 'none' : 'block';
            }

            // ‚¨ÖÔ∏è ÏôºÏ™Ω Ïù¥Îèô
            leftBtn.addEventListener("click", function () {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateSlide();
                }
            });

            // ‚û°Ô∏è Ïò§Î•∏Ï™Ω Ïù¥Îèô
            rightBtn.addEventListener("click", function () {
                if (currentIndex < maxIndex) {
                    currentIndex++;
                    updateSlide();
                }
            });

            // Ï¥àÍ∏∞ Ïä¨ÎùºÏù¥Îìú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            updateSlide();
        });
    });

    // Ï∞úÌïòÍ∏∞
    document.addEventListener("DOMContentLoaded", function () {
        const btns = document.querySelectorAll(".boardLike-btn");

        btns.forEach(btn => {
            const boardIdx = btn.dataset.boardIdx;
            const likeCountSpan = btn.parentElement.querySelector(".board-like-count");

            fetch(`/board/like-status/${boardIdx}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "liked") {
                        btn.textContent = "‚ù§Ô∏è";
                        likeCountSpan.textContent = data.likeCount;
                    } else if (data.status === "not_liked") {
                        btn.textContent = "üñ§";
                        likeCountSpan.textContent = data.likeCount;
                    }
                })
                .catch(error => console.error("Error :", error));

            btn.addEventListener("click", function () {
                fetch(`/board/like/${boardIdx}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                    .then(response => {
                        if (response.status === 401) {
                            alert("Î°úÍ∑∏Ïù∏ÏùÑ Ìï¥Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§");
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === "added") {
                            btn.textContent = "‚ù§Ô∏è";
                            likeCountSpan.textContent = Number(likeCountSpan.textContent) + 1;
                        } else if (data.status === "removed") {
                            btn.textContent = "üñ§";
                            likeCountSpan.textContent = Number(likeCountSpan.textContent) - 1;
                        }
                    })
                    .catch(error => console.error("Error :", error));
            });
        });
    });

    window.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("search");
        const historyList = document.getElementById("historyList");

        if (!searchInput || !historyList) return;

        searchInput.addEventListener("focus", () => {
            historyList.style.display = "block";
        });

        searchInput.addEventListener("blur", () => {
            setTimeout(() => {
                historyList.style.display = "none";
            }, 200);
        });

        historyList.addEventListener("mousedown", (e) => {
            e.preventDefault();
        });
    });
</script>