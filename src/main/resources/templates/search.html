<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/index.css}">
        <link rel="stylesheet" th:href="@{/css/search.css}">
        <link rel="stylesheet" th:href="@{/css/message.css}">
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="search-container">
        <div class="profile-info search-info">
            <a href="/">
                <div class="nav-item">
                    <img th:src="@{'/local-images/home-icon.png'}" alt="">
                    <span>홈</span>
                </div>
            </a>
            <a href="/search">
                <div class="nav-item">
                    <img th:src="@{'/local-images/search-message.png'}" alt="">
                    <span>탐색하기</span>
                </div>
            </a>
            <a href="">
                <div class="nav-item">
                    <img th:src="@{'/local-images/alarm-clock.png'}" alt="">
                    <span>알림</span>
                </div>
            </a>
            <!-- 로그인한 경우 -->
            <div th:if="${member != null}">
                <a th:href="@{'/message/' + ${member.idx}}">
                    <div class="nav-item">
                        <img th:src="@{'/local-images/email.png'}" alt="">
                        <span>쪽지</span>
                    </div>
                </a>
                <a th:href="@{'/profile/' + ${member.idx}}">
                    <div class="nav-item">
                        <img th:src="@{'/local-images/profile-user.png'}" alt="">
                        <span>프로필</span>
                    </div>
                </a>
            </div>

            <!-- 로그인하지 않은 경우 -->
            <div th:if="${member == null}">
                <div class="nav-item" onclick="alert('로그인이 필요합니다');">
                    <img th:src="@{'/local-images/email.png'}" alt="">
                    <span>쪽지</span>
                </div>
                <div class="nav-item" onclick="alert('로그인이 필요합니다');">
                    <img th:src="@{'/local-images/profile-user.png'}" alt="">
                    <span>프로필</span>
                </div>
            </div>
            <a href="/boardWrite">
                <div class="nav-item">
                    <img th:src="@{'/local-images/write.png'}" alt="">
                    <span>작성하기</span>
                </div>
            </a>

            <div class="bottom-profile">
                <div sec:authorize="isAuthenticated()">
                <img th:src="@{${'/profile-images/' + member.userImage}}" alt="프로필">
                <div>
                    <div class="bottom-name" th:text="${member.userName}"></div>
                    <div class="bottom-id" th:text="${member.userId}"></div>
                </div>
                </div>
            </div>
        </div>
        <div class="search-input">
            <div class="search-input-inner">
                <div class="search-input-middle">
                    <input type="text" placeholder="검색" name="search" id="search" th:value="${keyword}" onclick="historyLog()">
                    <img src="/local-images/send.png" alt="" width="20px" class="search-send-btn" onclick="searchBtn()">
                </div>
                <div class="search-sort" th:if="${keyword != null and keyword != ''}">
                    <ul>
                        <li><button class="sort-btn" th:value="'viewst'" th:classappend="${sort} == 'viewst' ? 'active' : ''">인기 게시물</button></li>
                        <li><button class="sort-btn" th:value="'latest'" th:classappend="${sort} == 'latest' ? 'active' : ''">최신 게시물</button></li>
                        <li><button class="sort-btn" th:value="'user'" th:classappend="${sort} == 'user' ? 'active' : ''">사용자</button></li>
                    </ul>
                </div>
                <div>
                    <ul>
                        <li>1</li>
                        <li>2</li>
                        <li>3</li>
                    </ul>
                </div>
            </div>
            <!-- 검색 결과가 있을 때만 보여줌 -->
            <div th:if="${boardList != null}">
                <div th:each="board : ${boardList}">
                    <p th:text="${board.boardContent}"></p>
                </div>
            </div>
            <!-- 검색 안 한 상태에서는 메시지 -->
            <div th:if="${boardList == null}">
                <p>검색어를 입력하고 버튼을 눌러보세요 🔍</p>
            </div>
        </div>
    </div>
</th:block>
</body>
</html>
<script>
    // 검색 버튼 클릭
    function searchBtn() {
        const keyword = document.getElementById("search").value.trim();
        if (keyword === '') {
            alert("검색어를 입력해주세요.");
            return;
        }

        // 선택된 정렬 값 가져오기 (기본값은 viewst)
        const activeSort = document.querySelector('.sort-btn.active');
        const sortValue = activeSort ? activeSort.value : 'viewst';

        // 검색어 + 정렬 파라미터로 이동
        const query = new URLSearchParams();
        query.append('keyword', keyword);
        query.append('sort', sortValue);

        location.href = '/search?' + query.toString();
        saveSearchKeywordToServer(keyword);

    }

    // 엔터키로 검색
    document.getElementById("search").addEventListener("keyup", function (event) {
        if (event.key === "Enter") {
            searchBtn();
        }
    });

    // 정렬 버튼 클릭
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('.sort-btn');

        buttons.forEach(button => {
            button.addEventListener('click', function () {
                const keyword = document.getElementById('search').value.trim();

                // 정렬 버튼 active 처리
                buttons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                // keyword가 없으면 검색어 입력 유도
                if (keyword === '') {
                    alert("검색어를 입력해주세요.");
                    return;
                }

                const sortValue = this.value;

                const query = new URLSearchParams();
                query.append('keyword', keyword);
                query.append('sort', sortValue);

                location.href = '/search?' + query.toString();
            });
        });
    });


    // 최근 검색기록 검색 기록 보내기 저장
    function saveSearchKeywordToServer(keyword) {
        fetch('/search-history', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ keyword: keyword })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("서버 에러 발생");
            }
            return response.json();
        })
        .then(data => {
            console.log("검색어 저장 성공:", data);
        })
        .catch(error => {
            console.error("검색어 저장 실패:", error);
        });
    }
</script>